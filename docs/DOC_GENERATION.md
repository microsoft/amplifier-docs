# Documentation Generation Guide

This guide explains how to use the documentation source mapping to maintain and regenerate Amplifier documentation.

## Overview

Amplifier documentation is sourced from multiple locations:
- **Source code** - Python docstrings, type hints, and implementation
- **Design documents** - Architecture and philosophy documents in source repos
- **Contract specifications** - Formal interface specifications
- **Module READMEs** - Module-specific documentation
- **Manual pages** - Hand-crafted guides and tutorials

The mapping between documentation pages and their sources is maintained in:
- `DOC_SOURCE_MAPPING.csv` - Machine-readable CSV format
- `DOC_SOURCE_MAPPING.md` - Human-readable Markdown format

## Documentation Types

### 1. Auto-Generated from Code

**Pages**: API Reference (most of `api/`)

**Source**: Python source files with docstrings

**Strategy**: Use `mkdocstrings` to extract API documentation from docstrings

**Example**:
```python
# In amplifier-core/amplifier_core/session.py
class AmplifierSession:
    """
    Manages an Amplifier session lifecycle.
    
    Args:
        mount_plan: Configuration for modules to load
        session_id: Optional session identifier
    """
```

**Generates**: `docs/api/core/session.md`

### 2. Transformed from Specifications

**Pages**: Contracts (`developer/contracts/`), Architecture specs

**Source**: Markdown files in source repositories

**Strategy**: Extract, transform, and enhance specification documents

**Example**:
```bash
# Source: amplifier-core/docs/contracts/PROVIDER_CONTRACT.md
# Destination: docs/developer/contracts/provider.md
# Transform: Add examples, cross-references, and navigation
```

### 3. Aggregated from Multiple Sources

**Pages**: Modules catalog, Libraries overview, Ecosystem

**Source**: Multiple module READMEs and source files

**Strategy**: Scan repositories, aggregate information, generate catalog pages

**Example**:
```bash
# Scan all amplifier-module-provider-*/ directories
# Extract name, description, configuration from each
# Generate unified catalog page
```

### 4. Manually Maintained

**Pages**: Getting Started, User Guide, Developer Guides

**Source**: Documentation repository only

**Strategy**: Direct editing, informed by source code and design docs

**Marked as**: `N/A` in source mapping

## Generation Workflow

### For Specific Page Types

#### API Reference

```bash
# API docs are generated by mkdocstrings during build
uv run mkdocs build

# mkdocstrings plugin reads Python files and generates API docs
# Configuration in mkdocs.yaml:
#   plugins:
#     - mkdocstrings:
#         handlers:
#           python:
#             options:
#               show_source: true
```

#### Module Catalogs

```bash
# Module catalog pages should be generated by scanning source repos
# Pseudocode:

for provider_dir in ~/repo/amplifier-dev/amplifier-module-provider-*/; do
    module_name=$(basename "$provider_dir")
    readme="$provider_dir/README.md"
    source_file="$provider_dir/${module_name//-/_}/__init__.py"
    
    # Extract metadata
    # Generate documentation page
done
```

#### Contract Pages

```bash
# Transform contract specifications
# Example for provider contract:

SOURCE=~/repo/amplifier-dev/amplifier-core/docs/contracts/PROVIDER_CONTRACT.md
DEST=docs/developer/contracts/provider.md

# Transform process:
# 1. Copy base content
# 2. Add navigation header
# 3. Add cross-references
# 4. Add code examples from modules
# 5. Add "See Also" section
```

### Automated Generation Script (Future)

```python
#!/usr/bin/env python3
"""
generate_docs.py - Regenerate documentation from sources

Usage:
    ./generate_docs.py --all          # Regenerate all documentation
    ./generate_docs.py --page api/core/session.md  # Single page
    ./generate_docs.py --category modules  # All module docs
"""

import csv
from pathlib import Path

def load_mapping():
    """Load documentation source mapping"""
    with open('docs/DOC_SOURCE_MAPPING.csv') as f:
        reader = csv.DictReader(f)
        return list(reader)

def generate_page(doc_page, source_files, notes):
    """Generate a documentation page from sources"""
    if source_files == 'N/A':
        print(f"Skipping {doc_page} (manually maintained)")
        return
    
    sources = source_files.split('|')
    
    # Strategy based on page type
    if doc_page.startswith('api/'):
        generate_api_doc(doc_page, sources)
    elif doc_page.startswith('modules/'):
        generate_module_doc(doc_page, sources)
    elif doc_page.startswith('developer/contracts/'):
        generate_contract_doc(doc_page, sources)
    else:
        print(f"No generator for {doc_page}")

def generate_api_doc(doc_page, sources):
    """Generate API documentation from Python source"""
    # Use mkdocstrings or custom parser
    pass

def generate_module_doc(doc_page, sources):
    """Generate module documentation from module source"""
    # Aggregate from module README and source
    pass

def generate_contract_doc(doc_page, sources):
    """Transform contract specification"""
    # Copy and enhance contract spec
    pass

if __name__ == '__main__':
    mapping = load_mapping()
    for entry in mapping:
        generate_page(
            entry['Documentation Page'],
            entry['Source Files'],
            entry['Notes']
        )
```

## Best Practices

### 1. Source of Truth

**Principle**: Code and contracts are the source of truth

- API documentation → Python docstrings
- Contracts → Specification files in amplifier-core/docs/contracts/
- Module capabilities → Module implementation and README
- Architecture → DESIGN_PHILOSOPHY.md and related docs

**Don't**: Manually edit auto-generated sections  
**Do**: Update source, then regenerate

### 2. Manual Enhancement

Some documentation requires human insight:
- **Tutorials** - Step-by-step guides
- **Explanations** - "Why" and architectural reasoning  
- **Examples** - Real-world usage patterns
- **Getting Started** - User onboarding flow

**Strategy**: Combine auto-generated API reference with manual guides

### 3. Validation

After generation, validate:

```bash
# Build documentation
uv run mkdocs build --strict

# Check for broken links
# Check for missing cross-references
# Verify code examples

# Preview
uv run mkdocs serve
```

### 4. Versioning

Documentation should track source versions:

```yaml
# In generated pages, include metadata:
---
title: Provider Contract
source: amplifier-core@v1.2.3/docs/contracts/PROVIDER_CONTRACT.md
generated: 2025-12-08
---
```

## Integration with CI/CD

### Automated Regeneration

```yaml
# .github/workflows/docs-regen.yml
name: Regenerate Documentation

on:
  schedule:
    - cron: '0 0 * * *'  # Daily
  workflow_dispatch:

jobs:
  regen-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: microsoft/amplifier-docs
          
      - name: Checkout source repositories
        run: |
          git clone https://github.com/microsoft/amplifier-core
          git clone https://github.com/microsoft/amplifier-app-cli
          # ... other repos
      
      - name: Generate documentation
        run: |
          python scripts/generate_docs.py --all
      
      - name: Create PR if changes
        uses: peter-evans/create-pull-request@v5
        with:
          title: "Auto-generated documentation update"
          commit-message: "Update documentation from source changes"
```

### Validation in PRs

```yaml
# .github/workflows/docs-validate.yml
name: Validate Documentation

on: [pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check mapping is current
        run: |
          # Verify all doc pages are in mapping
          # Verify all source files exist
          python scripts/validate_mapping.py
      
      - name: Build documentation
        run: |
          uv run mkdocs build --strict
```

## Common Scenarios

### Adding New Module Documentation

1. Module is created in `amplifier-dev/amplifier-module-{type}-{name}/`
2. Module includes README.md with standard structure
3. Add entry to `DOC_SOURCE_MAPPING.csv`:
   ```csv
   docs/modules/{type}/{name}.md,amplifier-module-{type}-{name}/amplifier_module_{type}_{name}/__init__.py|amplifier-module-{type}-{name}/README.md,{Type} module documentation
   ```
4. Run generator or manually create page from template
5. Update module catalog index page

### Updating Contract

1. Contract updated in `amplifier-core/docs/contracts/`
2. Run contract documentation generator:
   ```bash
   ./scripts/generate_docs.py --page developer/contracts/{name}.md
   ```
3. Review changes, especially:
   - Code examples still valid?
   - Cross-references still correct?
   - Navigation links work?

### Syncing API Reference

1. Code changes in `amplifier-core/amplifier_core/`
2. Docstrings updated in source
3. Documentation auto-regenerates on build:
   ```bash
   uv run mkdocs build
   ```
4. If manual enhancement needed, add to page using `///` admonitions

## Troubleshooting

### Stale Documentation

**Symptom**: Documentation doesn't match current code

**Solution**:
1. Check source file mapping
2. Verify source files are up to date
3. Regenerate from source
4. If still stale, source mapping may be incorrect

### Missing Cross-References

**Symptom**: Links between pages broken

**Solution**:
1. Use relative links in source
2. Verify target pages exist
3. Use `mkdocs build --strict` to catch broken links

### Inconsistent Formatting

**Symptom**: Generated docs don't match style guide

**Solution**:
1. Update generation templates
2. Use consistent markdown style
3. Apply post-processing formatting

---

## Next Steps

To implement full automation:

1. **Create generation scripts** in `scripts/`
2. **Add CI/CD workflows** in `.github/workflows/`
3. **Document generation templates** for each doc type
4. **Test on subset of pages** before full automation
5. **Monitor and iterate** based on results

For questions or issues, see [Contributing Guide](community/contributing.md).
